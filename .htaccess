# Activar el motor de reescritura
RewriteEngine On
RewriteBase /

# Forzar HTTPS (compatible con Hostinger)
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redirección canónica (elige una opción)
# Opción 1: Forzar no-www
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
# Opción 2: Forzar www (descomenta si prefieres)
# RewriteCond %{HTTP_HOST} !^www\. [NC]
# RewriteRule ^(.*)$ https://www.%{HTTP_HOST}/$1 [R=301,L]

# Deshabilitar listado de directorios
Options -Indexes

# Proteger archivos sensibles
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|env|json|config|yaml|yml)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Headers de seguridad y CSP (versión compatible con Hostinger)
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self' data:;"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# Deshabilitar la firma del servidor
ServerSignature Off

# Prevenir acceso a archivos ocultos
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Mostrar index.html cuando visiten /home/
RewriteRule ^home/?$ /index.html [L]

# URLs limpias para páginas en subcarpetas (ejemplo: /integrantes/ -> /pages/integrantes/integrantes.html)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^([a-zA-Z0-9_-]+)/?$ /pages/$1/$1.html [L]

# Comprimir archivos
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# URLs amigables - Eliminar extensión .html
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.html -f
RewriteRule ^(.*)$ $1.html [L]

# Forzar barra final
RewriteCond %{REQUEST_URI} /+[^\.]+$
RewriteRule ^(.+[^/])$ %{REQUEST_URI}/ [R=301,L]

# Prevenir hotlinking de imágenes
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?lawhpc\.org [NC]
RewriteRule \.(jpe?g|gif|bmp|png|webp)$ - [NC,F,L]

# Manejo de errores personalizados (asegúrate de crear estas páginas)
ErrorDocument 400 /components/error.html
ErrorDocument 401 /components/error.html
ErrorDocument 403 /components/error.html
ErrorDocument 404 /components/error.html
ErrorDocument 500 /components/error.html
# Cache y expiración
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresDefault "access plus 2 days"
</IfModule>

# 1. Protección contra inyección de código
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Bloquear intentos de inyección SQL
    RewriteCond %{QUERY_STRING} (;|<|>|'|"|\)|%0A|%0D|%22|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{QUERY_STRING} (exec|select|union|cast|declare|drop|update|md5|benchmark) [NC,OR]
    RewriteCond %{QUERY_STRING} (base64_encode|\.\.\/|\.\/) [NC]
    RewriteRule .* - [F]
</IfModule>

# 2. Proteger archivos sensibles
<FilesMatch "^(wp-config\.php|php\.ini|\.htaccess|\.env|composer\.json|package\.json)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# 3. Bloquear acceso a directorios específicos
<IfModule mod_autoindex.c>
    Options -Indexes
</IfModule>

# 4. Bloquear bots maliciosos
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(-|\.|) [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(.*)(<|>|%3C|%3E|%00) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} ^(java|curl|wget)([^.]*) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} ^(.*)(libwww-perl|libwwwperl|snoopy|winhttp|python|nikto|scan|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} ^(.*)(winhttp|wget|curl|perl|python|java) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} ^(.*)(spider|bot|tracker|crawler|spyder|spambot|feed|parser|fetcher|scanner|crawl|collector|grabber|sucker|poker|preview) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# 5. Prevenir hotlinking con dominio específico
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?tudominio\.com [NC]
    RewriteRule \.(jpg|jpeg|png|gif|svg|webp|mp4|webm|ogg|mp3|wav|pdf|doc|docx|xls|xlsx|ppt|pptx)$ - [NC,F,L]
</IfModule>

# 6. Mejorar la seguridad de las cookies
<IfModule mod_headers.c>
    Header edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure;SameSite=Strict
</IfModule>

# 7. Prevenir ataques XSS
<IfModule mod_headers.c>
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# 8. Configuración de caché mejorada
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    
    # Imágenes
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Fuentes
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    
    # CSS, JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    
    # HTML, XML
    ExpiresByType text/html "access plus 1 hour"
    ExpiresByType application/xhtml+xml "access plus 1 hour"
</IfModule>

# 9. Comprimir archivos
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE font/opentype font/ttf font/eot font/otf
</IfModule>